<h4>R Code:</h4>

<pre><code>endnote_mendeley_df &lt;- function(input_xml,
                                nrow_to_try = 1000){
  d1 &lt;- xmlTreeParse(input_xml, useInternal=T)
  top &lt;- xmlRoot(d1)

  output &lt;- matrix(ncol = 4, nrow = 0)
  for(i in 1:nrow_to_try)
  {
  # i = 1000
    if(is.na(xmlValue(top [[1]][[i]]))) break
    if(
      !is.na(xmlValue(top [[1]][[i]][["contributors"]][["authors"]][[2]]))
      )
    {
      author &lt;- paste(xmlValue(top [[1]][[i]][["contributors"]][["authors"]][[1]]), "et al", " ")
    } else {
      author &lt;- xmlValue(top [[1]][[i]][["contributors"]][["authors"]][[1]])
    }
    year &lt;- xmlValue(top [[1]][[i]][["dates"]][["year"]])
    title &lt;- xmlValue(top [[1]][[i]][["titles"]][[1]])
    endnoteref &lt;- xmlValue(top [[1]][[i]][["rec-number"]])
    output &lt;- rbind(output, c(author, year, title, endnoteref))

  }
  output &lt;- as.data.frame(output)
  return(output)
}
</code></pre>

<h4>R Test:</h4>

<pre><code>output &lt;- endnote_mendeley_df(
  input_xml = "EndnoteCollection.xml"
  ,
  nrow_to_try = 10
  )

nrow(output)
write.csv(output, "EndnoteCollection.csv", row.names = F)
output  &lt;- read.csv("EndnoteCollection.csv", stringsAsFactors = F)
str(output)
output[,1:2]
</code></pre>

<h4>R Do-read:</h4>

<pre><code>endnote &lt;- endnote_mendeley_df(
  input_xml = "EndnoteCollection.xml"
  )
nrow(endnote)
mendeley &lt;- endnote_mendeley_df(
  input_xml = "MendeleyCollection.xml"
  )
nrow(mendeley)
</code></pre>

<h4>R Do-concatenate and lowercase</h4>

<pre><code># TODO this is a really terrible way to do this.
# FIXME find out how to compare the two better
require(stringr)
mendeley2 &lt;- str_c(mendeley$V1, mendeley$V2, mendeley$V3)
mendeley2 &lt;- gsub(" ", "", mendeley2)
mendeley2 &lt;- gsub(",", "", mendeley2)
mendeley2 &lt;- tolower(mendeley2)
mendeley2[1:5]
mendeley$mendeley2 &lt;- mendeley2

# now do this again from endnote
endnote2 &lt;- str_c(endnote$V1, endnote$V2, endnote$V3)
endnote2 &lt;- gsub(" ", "", endnote2)
endnote2 &lt;- gsub(",", "", endnote2)
endnote2 &lt;- tolower(endnote2)
endnote2[1:5]
endnote$endnote2 &lt;- endnote2
</code></pre>

<h4>R Do-merge:</h4>

<pre><code>endnote_not_in_mendeley &lt;- merge(endnote,
                                 mendeley,
                                 by.x = "endnote2",
                                 by.y = "mendeley2",
                                 all.x = T)
str(endnote_not_in_mendeley)
nrow(endnote_not_in_mendeley)
head(endnote_not_in_mendeley)
endnote_not_in_mendeley &lt;- endnote_not_in_mendeley[
                                                   is.na(endnote_not_in_mendeley$V1.y),
                                                   ]
nrow(endnote_not_in_mendeley)
# 66 refs in endnote are not in mendeley
write.csv(endnote_not_in_mendeley,
      "endnote_not_in_mendeley.csv", row.names = F)
</code></pre>

<h4>Open this as spreadsheet and cross check</h4>

<ul>
<li>make a new column for comments</li>
<li>check off which ones were in AllDocuments and not in the Mendeley group</li>
<li>this diff was because of when I imported the Endnote XML but had not assigned these to the mendeley group</li>
<li>once have cleaned up the mendeley group export again and then check which are in mendeley but not in endnote</li>
</ul>


<h4>First here is a note</h4>

<ul>
<li>about a way to speed up the checks, excluding false positives using fuzzy matching</li>
<li>my method relies on the author, date and title to be written the same in both ie initials then surname or visa verca</li>
<li>But this is not always true</li>
<li>I previously used levenshtein string matching to identify strings that are close but not identical</li>
<li><a href="http://wiki.r-project.org/rwiki/doku.php?id=tips:data-strings:levenshtein">Try this link</a></li>
<li><a href="http://rwiki.sciviews.org/doku.php?id=tips:data-strings:levenshtein">OR this link</a></li>
<li>TODO I will share this code as a GitHub Gist later!</li>
</ul>


<h4>R Code: possibility to speed up Checks</h4>

<pre><code>tmp1 &lt;- mendeley[grep("Walker", mendeley$V1),"mendeley2"]
tmp2 &lt;- endnote[grep("Walker", endnote$V1),"endnote2"]

# these differ slightly
# B. Walker et al vs Walker, Brian et al
source("~/Dropbox/tools/levenshtein.r")
levenshtein(
    tmp1
    ,
    tmp2
    )
# gives 92percent match
</code></pre>

<h4>R Code: Find mendeley refs without endnote</h4>

<pre><code>  endnote &lt;- endnote_mendeley_df(
    input_xml = "EndnoteCollection.xml"
    )
  nrow(endnote)
  mendeley &lt;- endnote_mendeley_df(
    input_xml = "MendeleyCollection2.xml"
    )
  nrow(mendeley)
</code></pre>

<h4>R Code: Do-concatenate and lowercase</h4>

<pre><code>require(stringr)
mendeley2 &lt;- str_c(mendeley$V1, mendeley$V2, mendeley$V3)
mendeley2 &lt;- gsub(" ", "", mendeley2)
mendeley2 &lt;- gsub(",", "", mendeley2)
mendeley2 &lt;- tolower(mendeley2)
mendeley2[1:5]
mendeley$mendeley2 &lt;- mendeley2

# now do this again from endnote
endnote2 &lt;- str_c(endnote$V1, endnote$V2, endnote$V3)
endnote2 &lt;- gsub(" ", "", endnote2)
endnote2 &lt;- gsub(",", "", endnote2)
endnote2 &lt;- tolower(endnote2)
endnote2[1:5]
endnote$endnote2 &lt;- endnote2
</code></pre>

<h4>R Do-merge:</h4>

<pre><code>mendeley_not_in_endnote &lt;- merge(mendeley,
                                 endnote,
                                 by.y = "endnote2",
                                 by.x = "mendeley2",
                                 all.x = T)
str(mendeley_not_in_endnote)
nrow(mendeley_not_in_endnote)
head(mendeley_not_in_endnote)
mendeley_not_in_endnote &lt;- mendeley_not_in_endnote[
                                                      is.na(mendeley_not_in_endnote$V1.y),
                                                      ]
nrow(mendeley_not_in_endnote)
# 92 refs in endnote are not in mendeley
write.csv(mendeley_not_in_endnote,
      "mendeley_not_in_endnote.csv", row.names = F)
</code></pre>

<h4>Not all these 92 will be true</h4>

<ul>
<li>so let;s try the string matching</li>
</ul>


<h4>R Code:</h4>

<pre><code>source("~/Dropbox/tools/levenshtein.r")
pcnt_threshold &lt;- 0.6
out_list &lt;- matrix(ncol = 3, nrow = 0)
#out_list &lt;- read.csv("mendeley_not_in_endnote_fz_match.csv", stringsAsFactors = F)
for(i in 36:nrow(mendeley_not_in_endnote))
    {
        print(i)
#        i = 2
tmp1 &lt;- mendeley_not_in_endnote[i,1]
    for(j in 1:nrow(endnote))
        {
    #        j = 2
    if(exists("out")) rm(out)
    tmp2 &lt;- endnote$endnote2[j]
    pcnt &lt;- levenshtein(
            tmp1
            ,
            tmp2
            )
    #pcnt
    if(pcnt &gt;= pcnt_threshold) out &lt;- tmp2
    if(exists("out"))
        out_list &lt;- rbind(out_list, c(tmp1, tmp2, pcnt))
    if(exists("out")) break
        }

    }
out_list
write.csv(out_list, "mendeley_not_in_endnote_fz_match.csv", row.names = F)
</code></pre>

<h4>R Code: Do-concatenate and lowercase</h4>

<pre><code>require(stringr)
out_list &lt;- read.csv("mendeley_not_in_endnote_fz_match.csv", stringsAsFactors = F)
mendeley2 &lt;- read.csv("mendeley_not_in_endnote.csv", stringsAsFactors=F)
mendeley2[1,]
out_list[1,]
mendeley2 &lt;- merge(mendeley_not_in_endnote, out_list,
                   by.x = "mendeley2",
                   by.y = "V1", all.x = T)
mendeley2[2,]
mendeley2 &lt;- mendeley2[is.na(mendeley2$V3),]
nrow(mendeley2)
# 48 records
write.csv(mendeley2, "mendeley_not_in_endnote_best_estimate.csv", row.names=F)
</code></pre>

<h4>Results</h4>

<ul>
<li>I found that XML package in R can work with the Endnote and Mendeley export Files</li>
<li>I think I made a lot of bad decisions about the way I went about  doing this!</li>
<li>It seemed quite difficult to get the XML stuff to make sense to me</li>
<li>I;ve heard that python has better libraries for working with XML</li>
<li>the levenshtein string matching code proved useful again.  I should get out of the habit of looping and start using lapply etc to speed this up.</li>
</ul>


<h4>Conclusions</h4>

<ul>
<li>This was an interesting if frustrating experiment</li>
<li>The minor issues with importing from mendeley/endnote and deduplicating using their own tools was probably not worth writing all this half-baked R code.</li>
<li>But I did learn more about working with XML in R (and realised this is probably not one of R's Strengths -- or mine for that matter!)</li>
</ul>

